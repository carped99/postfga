/* slot.h */
#ifndef POSTFGA_SLOT_H
#define POSTFGA_SLOT_H

#pragma once

#define FGA_INVALID_SLOT UINT16_MAX

#ifdef __cplusplus
extern "C"
{
#endif

#include <postgres.h>
#include <port/atomics.h>
#include <storage/lwlock.h>
#include <lib/ilist.h>

#include "fga_type.h"
#include "channel_stream.h"

#ifdef __cplusplus
}
#endif

typedef enum FgaChannelSlotState
{
    FGA_SLOT_EMPTY = 0,
    FGA_SLOT_PENDING,
    FGA_SLOT_PROCESSING,
    FGA_SLOT_DONE,
    FGA_SLOT_ERROR
} FgaChannelSlotState;

typedef struct FgaChannelSlot
{
    slist_node node;        /* 내부 연결 리스트 용도 */
    pg_atomic_uint32 state; /* FgaChannelSlotState */
    pid_t backend_pid;
    uint64 request_id;
    uint16 pad;

    FgaRequest request;
    FgaChannelStream stream;
} FgaChannelSlot;

typedef struct FgaChannelSlotPool
{
    slist_head head;       /* 빈 슬롯 freelist (slist) */
    FgaChannelSlot *slots; /* [max_slots] */
    uint32 size;
} FgaChannelSlotPool;

#ifdef __cplusplus
extern "C"
{
#endif

    void postfga_slots_init(FgaChannelSlotPool *pool);

    bool postfga_slots_is_empty(FgaChannelSlotPool *pool);

    bool postfga_slots_pop_chunk(FgaChannelSlot *slot, FgaChannelStreamChunk *out_chunk);

#ifdef __cplusplus
}
#endif

#endif /* POSTFGA_SLOT_H */